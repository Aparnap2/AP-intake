groups:
- name: ap-intake-alerts
  rules:
  # API Health Alerts
  - alert: APIDown
    expr: up{job="ap-intake-api"} == 0
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "API service is down"
      description: "API service has been down for more than 1 minute"

  - alert: APIHighErrorRate
    expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.1
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High API error rate"
      description: "API error rate is {{ $value }} errors per second"

  - alert: APISlowResponse
    expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 2
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "API slow response time"
      description: "95th percentile response time is {{ $value }} seconds"

  # Database Alerts
  - alert: DatabaseDown
    expr: up{job="postgres"} == 0
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "Database is down"
      description: "PostgreSQL database has been down for more than 1 minute"

  - alert: DatabaseHighConnections
    expr: pg_stat_activity_count > 80
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High database connections"
      description: "Database has {{ $value }} active connections"

  - alert: DatabaseSlowQueries
    expr: rate(pg_stat_statements_mean_time_seconds[5m]) > 1
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "Slow database queries"
      description: "Average query time is {{ $value }} seconds"

  # Redis Alerts
  - alert: RedisDown
    expr: up{job="redis"} == 0
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "Redis is down"
      description: "Redis has been down for more than 1 minute"

  - alert: RedisHighMemory
    expr: redis_memory_used_bytes / redis_memory_max_bytes > 0.9
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "Redis high memory usage"
      description: "Redis memory usage is {{ $value | humanizePercentage }}"

  # Celery Worker Alerts
  - alert: CeleryWorkerDown
    expr: celery_workers_active == 0
    for: 2m
    labels:
      severity: critical
    annotations:
      summary: "No active Celery workers"
      description: "No Celery workers have been active for more than 2 minutes"

  - alert: CeleryQueueBacklog
    expr: celery_queue_length > 100
    for: 10m
    labels:
      severity: warning
    annotations:
      summary: "Celery queue backlog"
      description: "Queue {{ $labels.queue }} has {{ $value }} pending tasks"

  - alert: CeleryTaskFailureRate
    expr: rate(celery_task_failed_total[5m]) / rate(celery_task_started_total[5m]) > 0.1
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High Celery task failure rate"
      description: "Task failure rate is {{ $value | humanizePercentage }}"

  # Storage Alerts
  - alert: StorageSpaceLow
    expr: (node_filesystem_avail_bytes / node_filesystem_size_bytes) < 0.1
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "Low storage space"
      description: "Storage space is {{ $value | humanizePercentage }} available"

  - alert: MinIODown
    expr: up{job="minio"} == 0
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "MinIO is down"
      description: "MinIO object storage has been down for more than 1 minute"

  # System Resource Alerts
  - alert: HighCPUUsage
    expr: 100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High CPU usage"
      description: "CPU usage is {{ $value }}% on {{ $labels.instance }}"

  - alert: HighMemoryUsage
    expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes > 0.9
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High memory usage"
      description: "Memory usage is {{ $value | humanizePercentage }} on {{ $labels.instance }}"

  - alert: DiskSpaceLow
    expr: (node_filesystem_avail_bytes / node_filesystem_size_bytes) < 0.1
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: "Low disk space"
      description: "Disk space is {{ $value | humanizePercentage }} available on {{ $labels.instance }}"

  # SSL Certificate Alerts
  - alert: SSLCertificateExpiring
    expr: ssl_certificate_expiry_seconds < 2592000  # 30 days
    for: 1h
    labels:
      severity: warning
    annotations:
      summary: "SSL certificate expiring soon"
      description: "SSL certificate for {{ $labels.instance }} expires in {{ $value | humanizeDuration }}"

  # Application-specific Alerts
  - alert: InvoiceProcessingSlow
    expr: histogram_quantile(0.95, rate(invoice_processing_duration_seconds_bucket[10m])) > 300
    for: 10m
    labels:
      severity: warning
    annotations:
      summary: "Slow invoice processing"
      description: "95th percentile invoice processing time is {{ $value }} seconds"

  - alert: InvoiceProcessingFailures
    expr: rate(invoice_processing_failures_total[5m]) > 0.1
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High invoice processing failure rate"
      description: "Invoice processing failure rate is {{ $value }} per second"